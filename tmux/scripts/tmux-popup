#!/usr/bin/env bash

# This script provides a long-running popup integration in tmux for running common tools
# without cluttering the main tmux session.
#
# When asked to run a tool, it runs that tool (or switches to it if already running) in a dedicated
# tmux server (on its own socket) in a window, and opens this window in the main tmux popup win.
#
# The script is meant to be controlled from the main tmux via key bindings that open, switch,
# toggle, and inspect the popup session.

set -euo pipefail # Safe, strict script execution

# This var is used to change the role of the tmux server started from this script
# (really used to change my config conditionally)
export TMUX_SERVER_ROLE="popup"

POPUP_SESSION="popup"
POPUP_SOCKET="${TMUX_POPUP_SOCKET:-/tmp/tmux-popup.sock}"
POPUP_DEFAULT_SHELL="zsh"

function show_err()
{
  echo >&2 "ERROR:" "$@"
}

function show_info()
{
  echo >&2 "|" "$@"
}

function show_usage()
{
  show_info
  show_info "Helper script to manage a persistent tmux popup"
  show_info
  show_info "Each popup id maps to a window in a dedicated background tmux session"
  show_info "so programs can keep running after the popup closes."
  show_info
  show_info "Usages:"
  show_info
  show_info "  tmux-popup -h|--help|help"
  show_info "  -> Show this help"
  show_info
  show_info "  tmux-popup [shell]"
  show_info '  -> Same as `tmux-popup switch shell $POPUP_DEFAULT_SHELL`'
  show_info
  show_info "  tmux-popup switch [--id=ID] COMMAND [ARGS...]"
  show_info "  -> Show a popup window named 'ID' (default: COMMAND's basename) running COMMAND [ARGS...]"
  show_info
  show_info "  tmux-popup toggle"
  show_info "  -> If popup is visible: close it; otherwise reopen the last popup window"
  show_info
  show_info "  tmux-popup status"
  show_info "  -> Show popup server, session, window and client status"
  show_info
}

function current_session_name()
{
  tmux display-message -p -F "#{session_name}"
}

# Path of the pane in the main tmux server
function current_pane_path()
{
  tmux display-message -p -F "#{pane_current_path}"
}

function ensure_running_inside_tmux()
{
  if ! current_session_name >/dev/null 2>&1; then
    show_err "tmux-popup must be run from inside tmux (run-shell, key binding, etc.)"
    exit 1
  fi
}

function check_in_popup_session()
{
  local session="$(current_session_name 2>/dev/null || true)"
  [[ "$session" == "$POPUP_SESSION" ]]
}

function check_popup_win_exists()
{
  local winid="$1"
  popup_tmux list-windows -t "$POPUP_SESSION" -F "#{window_name}" 2>/dev/null | grep -qx -- "$winid"
}

function popup_tmux()
{
  tmux -S "$POPUP_SOCKET" "$@"
}

function popup_server_reachable()
{
  if popup_tmux list-sessions >/dev/null 2>&1; then
    return 0
  fi
  return 1
}

function ensure_popup_server()
{
  if popup_server_reachable; then
    return
  fi

  if [ -S "$POPUP_SOCKET" ]; then
    show_err "Popup tmux server not responding, removing stale socket: $POPUP_SOCKET"
    rm -f -- "$POPUP_SOCKET"
  fi
}

function popup_display()
{
  local tmux_args="$1"

  tmux display-popup -d '#{pane_current_path}' -yS -w90% -h85% -E \
    "TMUX='' tmux -S '$POPUP_SOCKET' $tmux_args" || {
      show_err "Failed to open tmux popup; popup server may be unreachable."
      exit 1
    }
}

function popup_server_status()
{
  echo "Popup socket: $POPUP_SOCKET"

  if ! popup_server_reachable; then
    if [ -S "$POPUP_SOCKET" ]; then
      show_err "Popup server not reachable; socket exists (likely stale)."
    else
      echo "No popup server; socket does not exist."
    fi
    return 1
  fi

  echo "Popup server is reachable."

  if popup_tmux has-session -t "$POPUP_SESSION" 2>/dev/null; then
    echo "Popup session '$POPUP_SESSION' exists."

    echo "Windows in popup session '$POPUP_SESSION':"
    popup_tmux list-windows -t "$POPUP_SESSION" \
      -F "  - #{window_name}"

    return 0
  fi

  show_err "Popup session '$POPUP_SESSION' does not exist yet."
  return 1
}

function ensure_popup_session_exists()
{
  ensure_popup_server

  if ! popup_tmux has-session -t "$POPUP_SESSION" 2>/dev/null; then
    show_info "Creating popup session '$POPUP_SESSION' on socket '$POPUP_SOCKET'"
    popup_tmux new-session -d -s "$POPUP_SESSION" -n "shell" "$POPUP_DEFAULT_SHELL"

    # Inside the popup tmux server, make Alt-Escape detach the client.
    # This does not affect the main tmux server.
    popup_tmux bind-key -n M-Escape detach-client
  else
    show_info "Session '$POPUP_SESSION' already exists on popup socket"
  fi
}

function popup_switch_window()
{
  local winid="$1"; shift || true
  local cmd=("$@")
  if [ "${#cmd[@]}" -eq 0 ]; then
    cmd=("$POPUP_DEFAULT_SHELL")
  fi

  ensure_running_inside_tmux

  local in_popup
  if check_in_popup_session; then
    in_popup=true
  else
    in_popup=false
    ensure_popup_session_exists
  fi

  show_info "Switch window winid='$winid' cmd='${cmd[*]}'"

  # Create window if it does not exist yet
  if ! check_popup_win_exists "$winid"; then
    show_info "Creating window '$winid' in popup session"
    # Use the current pane path as the starting directory.
    # When called from the main tmux, this captures the main pane path.
    # When called from inside the popup, this captures the popup pane path.
    local pane_path="$(current_pane_path)"
    popup_tmux new-window -t "$POPUP_SESSION" -n "$winid" -c "$pane_path" "${cmd[@]}"
  else
    show_info "Window '$winid' already exists in popup session"
  fi

  if ! $in_popup; then
    # Ensure the popup session will start on this window when opened as a popup
    popup_tmux select-window -t "$POPUP_SESSION:$winid"

    show_info "Opening popup session on window '$winid' via popup socket"
    popup_display "attach-session -t '$POPUP_SESSION' \; select-window -t '$winid'"
  else
    # Already inside popup session: just select the window, no nested popup.
    popup_tmux select-window -t "$POPUP_SESSION:$winid"
  fi
}


function popup_toggle()
{
  ensure_running_inside_tmux

  check_in_popup_session && {
    show_info "Toggle from inside the popup, detaching client!"
    popup_tmux detach-client
    return
  }

  # If the popup tmux server has any attached clients,
  # treat this as "popup visible" and just detach them.
  if popup_tmux list-clients 2>/dev/null | grep -q .; then
    show_info "Popup session has clients: detaching all clients!"
    popup_tmux detach-client -a
    return
  fi

  # No attached popup client, reopen popup session on last active window
  ensure_popup_session_exists

  show_info "Reopening popup session on last active window"
  popup_display "attach-session -t '$POPUP_SESSION'"
}

function main()
{
  ensure_running_inside_tmux

  case "${1-}" in
    -h|--help|help)
      show_usage
      ;;
    status)
      shift || true
      if [ "$#" -ne 0 ]; then
        show_err "Usage: tmux-popup status"
        show_usage
        exit 1
      fi
      popup_server_status
      ;;
    toggle)
      shift || true
      if [ "$#" -ne 0 ]; then
        show_err "Usage: tmux-popup toggle"
        show_usage
        exit 1
      fi
      popup_toggle
      ;;
    switch)
      shift || true

      local winid=""
      if [[ "${1-}" == --id=* ]]; then
        # Strip the "--id=" prefix to get the window id
        winid="${1#--id=}"
        shift || true
      fi

      if [ "$#" -lt 1 ]; then
        show_err "Usage: tmux-popup switch [--id=ID] COMMAND [ARGS...]"
        show_usage
        exit 1
      fi

      if [ -z "$winid" ]; then
        # Use the basename of the command path as default window id
        winid="${1##*/}"
      fi

      popup_switch_window "$winid" "$@"
      ;;

    shell|"")
      # Default shell popup, equivalent to: switch shell $POPUP_DEFAULT_SHELL
      shift || true
      popup_switch_window "shell" "$POPUP_DEFAULT_SHELL"
      ;;
    *)
      show_err "Unknown subcommand: $1"
      show_usage
      exit 1
      ;;
  esac
}

main "$@"
