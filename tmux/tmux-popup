#!/usr/bin/env bash

set -euo pipefail # Safe, strict script execution

POPUP_SESSION_NAME="popup"
TMUX_SOCKET=""

if [ -n "${TMUX-}" ]; then
  TMUX_SOCKET="${TMUX%%,*}"
fi

function show_err()
{
  echo >&2 '!!' "$@"
}

function show_info()
{
  echo >&2 '|' "$@"
}

function show_usage()
{
  show_info
  show_info "Helper to manage the tmux popup"
  show_info "It is implemented using a dedicated 'popup' session for background support,"
  show_info "each program runs in a named window."
  show_info
  show_info "Usages:"
  show_info
  show_info "  tmux-popup -h|--help|help"
  show_info "    > Show this help"
  show_info
  show_info "  tmux-popup [shell]"
  show_info '    > Same as `tmux-popup toggle shell $SHELL`'
  show_info
  show_info "  tmux-popup close"
  show_info "    > If popup is visible: close it; otherwise reopen the last popup window"
  show_info
  show_info "  tmux-popup toggle ID COMMAND [ARGS...]"
  show_info "    > Toggle a named popup window 'ID' running COMMAND [ARGS...]"
  show_info
}

function current_session_name()
{
  tmux display-message -p -F "#{session_name}"
}

function ensure_running_inside_tmux()
{
  if ! current_session_name >/dev/null 2>&1; then
    show_err "tmux-popup must be run from inside tmux (run-shell, key binding, etc.)"
    exit 1
  fi
}

function ensure_popup_session_exists()
{
  if ! tmux has-session -t "$POPUP_SESSION_NAME" 2>/dev/null; then
    show_info "Creating session '$POPUP_SESSION_NAME'"
    # Create the popup session with a default 'shell' window
    tmux new-session -d -s "$POPUP_SESSION_NAME" -n "shell" "${SHELL:-/bin/sh}"
  else
    show_info "Session '$POPUP_SESSION_NAME' already exists"
  fi
}

function popup_toggle_window()
{
  local id="$1"; shift || true
  local cmd=("$@")

  show_info "Toggle window id='$id' cmd='${cmd[*]:-(default shell)}'"
  ensure_popup_session_exists

  # Create window if it does not exist yet
  if ! tmux list-windows -t "$POPUP_SESSION_NAME" -F "#{window_name}" 2>/dev/null | grep -qx -- "$id"; then
    if [ "${#cmd[@]}" -eq 0 ]; then
      cmd=("${SHELL:-/bin/sh}")
    fi
    show_info "Creating window '$id' in session '$POPUP_SESSION_NAME'"
    tmux new-window -t "$POPUP_SESSION_NAME" -n "$id" "${cmd[@]}"
  else
    show_info "Window '$id' already exists in session '$POPUP_SESSION_NAME'"
  fi

  # Ensure the popup session will start on this window
  tmux select-window -t "$POPUP_SESSION_NAME:$id"

  local current_session current_window
  current_session="$(current_session_name)"
  current_window="$(tmux display-message -p -F "#{window_name}")"

  if [ "$current_session" = "$POPUP_SESSION_NAME" ] && [ "$current_window" = "$id" ]; then
    # Currently in this popup window -> detach (hide popup)
    show_info "Detaching client from session '$POPUP_SESSION_NAME' window '$id'"
    tmux detach-client
    return
  fi

  # Record last popup id
  tmux set-option -gq "@popup_last_id" "$id"
  show_info "Opening popup on session '$POPUP_SESSION_NAME' window '$id'"

  # Show popup on the requested window
  tmux display-popup -d '#{pane_current_path}' -xC -yC -w90% -h85% -E \
    "TMUX='' tmux -S '${TMUX_SOCKET}' attach-session -t '$POPUP_SESSION_NAME' \; select-window -t '$id'"
}

function popup_close()
{
  ensure_running_inside_tmux

  local current_session
  current_session="$(current_session_name)"

  if [ "$current_session" = "$POPUP_SESSION_NAME" ]; then
    # We are in the popup session -> close it
    local current_window
    current_window="$(tmux display-message -p -F "#{window_name}")"
    show_info "Closing popup: detaching from session '$POPUP_SESSION_NAME' window '$current_window'"
    tmux detach-client
    return
  fi

  # Not in popup session -> reopen last popup window if known
  local last_id
  last_id="$(tmux show-option -gqv "@popup_last_id" 2>/dev/null || true)"
  if [ -z "$last_id" ]; then
    show_info "Close requested but no last popup recorded"
    return 1
  fi

  ensure_popup_session_exists

  # If the window disappeared, just bail out nicely
  if ! tmux list-windows -t "$POPUP_SESSION_NAME" -F "#{window_name}" 2>/dev/null | grep -qx -- "$last_id"; then
    show_err "last popup window '$last_id' no longer exists in session '$POPUP_SESSION_NAME'"
    return 1
  fi

  show_info "Reopening last popup: session '$POPUP_SESSION_NAME' window '$last_id'"
  tmux display-popup -d '#{pane_current_path}' -xC -yC -w90% -h85% -E \
    "TMUX='' tmux -S '${TMUX_SOCKET}' attach-session -t '$POPUP_SESSION_NAME' \; select-window -t '$last_id'"
}

function main()
{
  ensure_running_inside_tmux

  case "${1-}" in
    -h|--help|help)
      show_usage
      ;;
    close)
      shift || true
      popup_close
      ;;
    toggle)
      shift || true
      if [ "$#" -lt 2 ]; then
        show_err "Usage: tmux-popup toggle ID COMMAND [ARGS...]"
        show_usage
        exit 1
      fi
      local id="$1"; shift
      popup_toggle_window "$id" "$@"
      ;;
    shell|"")
      # Default shell popup, equivalent to: toggle shell $SHELL
      shift 2>/dev/null || true
      popup_toggle_window "shell" "${SHELL:-/bin/sh}"
      ;;
    *)
      show_err "Unknown subcommand: $1"
      show_usage
      exit 1
      ;;
  esac
}

main "$@"
