#!/usr/bin/env bash

set -euo pipefail # Safe, strict script execution

POPUP_SESSION_NAME="popup"
POPUP_SOCKET="${TMUX_POPUP_SOCKET:-/tmp/tmux-popup.sock}"


function show_err()
{
  echo >&2 '!! ERROR:' "$@"
}

function show_info()
{
  echo >&2 '|' "$@"
}

function show_usage()
{
  show_info
  show_info "Helper script to manage a persistent tmux popup"
  show_info
  show_info "Each popup id maps to a window in a dedicated background tmux session"
  show_info "so programs can keep running after the popup closes."
  show_info
  show_info "Usages:"
  show_info
  show_info "  tmux-popup -h|--help|help"
  show_info "  -> Show this help"
  show_info
  show_info "  tmux-popup [shell]"
  show_info '  -> Same as `tmux-popup switch shell $SHELL`'
  show_info
  show_info "  tmux-popup switch ID COMMAND [ARGS...]"
  show_info "  -> Show a named popup window 'ID' running COMMAND [ARGS...]"
  show_info
  show_info "  tmux-popup toggle"
  show_info "  -> If popup is visible: close it; otherwise reopen the last popup window"
  show_info
}

function current_session_name()
{
  tmux display-message -p -F "#{session_name}"
}

function ensure_running_inside_tmux()
{
  if ! current_session_name >/dev/null 2>&1; then
    show_err "tmux-popup must be run from inside tmux (run-shell, key binding, etc.)"
    exit 1
  fi
}

function popup_tmux()
{
  tmux -S "$POPUP_SOCKET" "$@"
}

function popup_display()
{
  # Usage: popup_display "attach-session -t '$POPUP_SESSION_NAME' \; select-window -t '$id'"
  local tmux_args="$1"

  tmux display-popup -d '#{pane_current_path}' -yS -w90% -h85% -E \
    "TMUX='' tmux -S '$POPUP_SOCKET' $tmux_args"
}

function ensure_popup_session_exists()
{
  if ! popup_tmux has-session -t "$POPUP_SESSION_NAME" 2>/dev/null; then
    show_info "Creating popup session '$POPUP_SESSION_NAME' on socket '$POPUP_SOCKET'"
    popup_tmux new-session -d -s "$POPUP_SESSION_NAME" -n "shell" "${SHELL:-/bin/sh}"

    # Inside the popup tmux server, make Alt-Escape detach the client.
    # This does not affect the main tmux server.
    popup_tmux bind-key -n M-Escape detach-client
  else
    show_info "Session '$POPUP_SESSION_NAME' already exists on popup socket"
  fi
}

function popup_switch_window()
{
  local id="$1"; shift || true
  local cmd=("$@")

  ensure_running_inside_tmux
  ensure_popup_session_exists

  if [ "${#cmd[@]}" -eq 0 ]; then
    cmd=("${SHELL:-/bin/sh}")
  fi

  show_info "Switch window id='$id' cmd='${cmd[*]}'"

  # Create window if it does not exist yet
  if ! popup_tmux list-windows -t "$POPUP_SESSION_NAME" -F "#{window_name}" 2>/dev/null | grep -qx -- "$id"; then
    show_info "Creating window '$id' in popup session '$POPUP_SESSION_NAME'"
    popup_tmux new-window -t "$POPUP_SESSION_NAME" -n "$id" "${cmd[@]}"
  else
    show_info "Window '$id' already exists in popup session '$POPUP_SESSION_NAME'"
  fi

  # Ensure the popup session will start on this window
  popup_tmux select-window -t "$POPUP_SESSION_NAME:$id"

  show_info "Opening popup on session '$POPUP_SESSION_NAME' window '$id' via popup socket"

  popup_display "attach-session -t '$POPUP_SESSION_NAME' \; select-window -t '$id'"
}

function popup_toggle()
{
  ensure_running_inside_tmux

  # If the popup tmux server has any attached clients,
  # treat this as "popup visible" and just detach them.
  if popup_tmux list-clients 2>/dev/null | grep -q .; then
    show_info "Closing popup: detaching all clients from popup session '$POPUP_SESSION_NAME'"
    popup_tmux detach-client -a
    return
  fi

  # No attached popup client -> reopen popup session on its last active window
  ensure_popup_session_exists

  show_info "Reopening popup session '$POPUP_SESSION_NAME' on last active window"
  popup_display "attach-session -t '$POPUP_SESSION_NAME'"
}

function main()
{
  ensure_running_inside_tmux

  case "${1-}" in
    -h|--help|help)
      show_usage
      ;;
    toggle)
      shift || true
      if [ "$#" -eq 0 ]; then
        # No arguments: behave like close/reopen last popup
        popup_toggle
      else
        show_err "Usage: tmux-popup toggle"
        show_usage
        exit 1
      fi
      ;;
    switch)
      shift || true
      if [ "$#" -lt 1 ]; then
        show_err "Usage: tmux-popup switch ID COMMAND [ARGS...]"
        show_usage
        exit 1
      fi
      local id="$1"; shift
      popup_switch_window "$id" "$@"
      ;;
    shell|"")
      # Default shell popup, equivalent to: switch shell $SHELL
      shift || true
      popup_switch_window "shell" "${SHELL:-/bin/sh}"
      ;;
    *)
      show_err "Unknown subcommand: $1"
      show_usage
      exit 1
      ;;
  esac
}

main "$@"
