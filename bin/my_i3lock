#!/bin/zsh

#
# i3lock options
#
# -e ➤ --ignore-empty-password
# -f ➤ --show-failed-attempts
# -n ➤ --nofork
# -i ➤ --image=
#

i3lock_options=(-f -e)

loading_img=${HOME}/wallpapers/hacker-virus-loading-computer-1920x1080-blured.png
final_img=/tmp/screenshot_i3.png

# Screenshot of desktop
import -window root -quality 0 ${final_img}

pkill unclutter

# First loading lock
i3lock -n ${i3lock_options[@]} -i "$loading_img" &!
loading_pid=$!
echo "first is at $loading_pid"

# Generating real lockscreen image
# ➤ blur
convert ${final_img} -blur 0x10 ${final_img}

echo "Real lockscreen generated, killing $loading_pid"
kill $loading_pid
echo "Running new i3lock with real lockscreen image"

# Real lock
i3lock ${i3lock_options[@]} -i "${final_img}"
locker_status=$?

if ! [ "$locker_status" -eq 0 ]; then
	echo "bad locker_status: $locker_status"
	i3lock -i "$loading_img";
fi

unclutter &!
